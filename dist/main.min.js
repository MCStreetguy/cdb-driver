"use strict";var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var r=t[s];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,s,r){return s&&e(t.prototype,s),r&&e(t,r),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var btoa=require("btoa"),_isset=require("isset-helper"),CDBDriver=function(){function e(t){if(_classCallCheck(this,e),_isset(t,"object")){if(!_isset(t.host,"string"))throw new TypeError("CDBDriver configuration is missing required key: host!");this.host=t.host,_isset(t.user,"string")&&_isset(t.pass,"string")?(this._auth=!0,this.user=t.user,this.pass=t.pass):this._auth=!1}else{if(!_isset(t,"string"))throw new TypeError("Invalid configuration passed to CDBDriver constructor!");try{if(t.includes("@")){this._auth=!0;var s=t.split("@"),r=s[0].split("//")[0]+"//",i=s[0].split("//")[1];this.user=i.split(":")[0],this.pass=i.split(":")[1],this.host=r+s[1].split(":")[0]+":"+parseInt(s[1].split(":")[1])}else this._auth=!1,this.host=t}catch(e){throw new TypeError("An error occurred while parsing CouchDB URL string.")}}this.host.endsWith("/")||(this.host=this.host+"/");try{new XMLHttpRequest,this._mode="xhr"}catch(e){throw this._mode="curl",new Error("CDBDriver currently not supports CURL mode!")}var n=this.info();parseInt(n.version)<2?this.legacy=!0:this.legacy=!1}return _createClass(e,[{key:"_getAuthHeader",value:function(){return"Basic "+btoa(this.user+":"+this.pass)}},{key:"_setAuthHeader",value:function(e){e.setRequestHeader("Authorization",this._getAuthHeader())}},{key:"_buildCURL",value:function(e){var t="curl ";return _isset(e.method,"string")?t+="-X "+e.method+" ":t+="-X GET ",e.verbose&&(t+="-v "),_isset(e.data,"object")?(t+='-H "Content-Type: application/json" ',t+='-d "'+JSON.stringify(e.data)+'" '):_isset(e.data,"string")&&(t+='-d "'+e.data+'"'),this._auth&&(t+='-H "Authorization: '+this._getAuthHeader()+'" '),_isset(e.location,"string")?t+=this.host+e.location:t+=this.host,t}},{key:"_parseCURLResponse",value:function(e,t){var s,r;if(t){s={},r="",e.split("\n").forEach(function(e,t,i){if(e.startsWith("*"));else if(e.startsWith(">"));else if(e.startsWith("<")){e.replace("< ","");e.includes("HTTP/")&&(s.code=parseInt(e.replace(new RegExp("HTTP/[^s]+ "),"")))}else r+=e});try{s.body=JSON.parse(r)}catch(e){s.body=r}finally{return s}}else try{s=JSON.parse(e)}catch(t){return e}finally{return s}}},{key:"info",value:function(e){if("xhr"==this._mode){var t=new XMLHttpRequest;if(!_isset(e,"function")){t.open("GET",this.host,!1),this._auth&&this._setAuthHeader(t),t.send();try{var s=JSON.parse(t.response)}catch(e){s=t.response}return{state:t.status,response:s}}t.addEventListener("load",function(s){try{var r=JSON.parse(t.response)}catch(e){r=t.response}e({state:t.status,response:r})}),t.open("GET",this.host),this._auth&&this._setAuthHeader(t),t.send()}}},{key:"allDbs",value:function(e){if("xhr"==this._mode){var t=new XMLHttpRequest;if(!_isset(e,"function")){t.open("GET",this.host+"_all_dbs",!1),this._auth&&this._setAuthHeader(t),t.send();try{var s=JSON.parse(t.response)}catch(e){s=t.response}return{state:t.status,response:s}}t.addEventListener("load",function(s){try{var r=JSON.parse(t.response)}catch(e){r=t.response}e({state:t.status,response:r})}),t.open("GET",this.host+"_all_dbs"),this._auth&&this._setAuthHeader(t),t.send()}else _isset(e,"function")}},{key:"getDb",value:function(e,t){if(!_isset(e,"string"))throw new Error("CDBDriver.db() is missing required argument: dbIdentifier!");if("xhr"==this._mode){var s=new XMLHttpRequest;if(!_isset(t,"function")){s.open("GET",this.host+e,!1),this._auth&&this._setAuthHeader(s),s.send();try{var r=JSON.parse(s.response)}catch(e){r=s.response}return{state:s.status,response:r}}s.addEventListener("load",function(e){try{var r=JSON.parse(s.response)}catch(e){r=s.response}t({state:s.status,response:r})}),s.open("GET",this.host+e),this._auth&&this._setAuthHeader(s),s.send()}}},{key:"createDb",value:function(e,t){if(!_isset(e,"string"))throw new Error("CDBDriver.createDb() is missing required argument: dbIdentifier!");if("xhr"==this._mode){var s=new XMLHttpRequest;if(!_isset(t,"function")){s.open("PUT",this.host+e,!1),this._auth&&this._setAuthHeader(s),s.send();try{var r=JSON.parse(s.response)}catch(e){r=s.response}return{state:s.status,response:r}}s.addEventListener("load",function(e){try{var r=JSON.parse(s.response)}catch(e){r=s.response}t({state:s.status,response:r})}),s.open("PUT",this.host),this._auth&&this._setAuthHeader(s),s.send()}}},{key:"getDocs",value:function(e,t){if(!_isset(e,"string"))throw new Error("CDBDriver.getDocs() is missing required argument: dbIdentifier!");if("xhr"==this._mode){var s=new XMLHttpRequest;if(!_isset(t,"function")){s.open("GET",this.host+e+"/_all_docs",!1),this._auth&&this._setAuthHeader(s),s.send();try{var r=JSON.parse(s.response)}catch(e){r=s.response}return{state:s.status,response:r}}s.addEventListener("load",function(e){try{var r=JSON.parse(s.response)}catch(e){r=s.response}t({state:s.status,response:r})}),s.open("GET",this.host+e+"/_all_docs"),this._auth&&this._setAuthHeader(s),s.send()}}},{key:"storeDoc",value:function(e,t,s){if(!_isset(e,"string"))throw new Error("CDBDriver.storeDoc() is missing required argument: dbIdentifier!");if(!_isset(t,"object"))throw new Error("CDBDriver.storeDoc() is missing required argument: data!");if("xhr"==this._mode){var r=new XMLHttpRequest;if(!_isset(s,"function")){r.open("POST",this.host+e,!1),this._auth&&this._setAuthHeader(r),r.setRequestHeader("Content-Type","application/json"),r.send(JSON.stringify(t));try{var i=JSON.parse(r.response)}catch(e){i=r.response}return{state:r.status,response:i}}r.addEventListener("load",function(e){try{var t=JSON.parse(r.response)}catch(e){t=r.response}s({state:r.status,response:t})}),r.open("POST",this.host+e),this._auth&&this._setAuthHeader(r),r.setRequestHeader("Content-Type","application/json"),r.send(JSON.stringify(t))}}},{key:"getDoc",value:function(e,t,s){if(!_isset(e,"string"))throw new Error("CDBDriver.getDoc() is missing required argument: dbIdentifier!");if(!_isset(t,"string"))throw new Error("CDBDriver.getDoc() is missing required argument: docIdentifier!");if("xhr"==this._mode){var r=new XMLHttpRequest;if(!_isset(s,"function")){r.open("GET",this.host+e+"/"+t,!1),this._auth&&this._setAuthHeader(r),r.send();try{var i=JSON.parse(r.response)}catch(e){i=r.response}return{state:r.status,response:i}}r.addEventListener("load",function(e){try{var t=JSON.parse(r.response)}catch(e){t=r.response}s({state:r.status,response:t})}),r.open("GET",this.host+e+"/"+t),this._auth&&this._setAuthHeader(r),r.send()}}},{key:"deleteDoc",value:function(e,t,s,r){if(!_isset(e,"string"))throw new Error("CDBDriver.deleteDoc() is missing required argument: dbIdentifier!");if(!_isset(t,"string"))throw new Error("CDBDriver.deleteDoc() is missing required argument: docIdentifier!");if(!_isset(s,"string"))throw new Error("CDBDriver.deleteDoc() is missing required argument: docRevision!");if("xhr"==this._mode){var i=new XMLHttpRequest;if(!_isset(r,"function")){i.open("DELETE",this.host+e+"/"+t+"?rev="+s,!1),this._auth&&this._setAuthHeader(i),i.send();try{var n=JSON.parse(i.response)}catch(e){n=i.response}return{state:i.status,response:n}}i.addEventListener("load",function(e){try{var t=JSON.parse(i.response)}catch(e){t=i.response}r({state:i.status,response:t})}),i.open("DELETE",this.host+e+"/"+t+"?rev="+s),this._auth&&this._setAuthHeader(i),i.send()}}},{key:"updateDoc",value:function(e,t,s,r,i){if(!_isset(e,"string"))throw new Error("CDBDriver.updateDoc() is missing required argument: dbIdentifier!");if(!_isset(t,"string"))throw new Error("CDBDriver.updateDoc() is missing required argument: docIdentifier!");if(!_isset(s,"string"))throw new Error("CDBDriver.updateDoc() is missing required argument: docRevision!");if(!_isset(r,"object"))throw new Error("CDBDriver.updateDoc() is missing required argument: data!");if("xhr"==this._mode){var n=new XMLHttpRequest;if(!_isset(i,"function")){n.open("PUT",this.host+e+"/"+t+"?rev="+s,!1),this._auth&&this._setAuthHeader(n),n.setRequestHeader("Content-Type","application/json"),n.send(JSON.stringify(r));try{var a=JSON.parse(n.response)}catch(e){a=n.response}return{state:n.status,resposne:a}}n.addEventListener("load",function(e){try{var t=JSON.parse(n.response)}catch(e){t=n.response}i({state:n.status,response:t})}),n.open("PUT",this.host+e+"/"+t+"?rev="+s),this._auth&&this._setAuthHeader(n),n.setRequestHeader("Content-Type","application/json"),n.send(JSON.stringify(r))}}}]),e}();try{module.exports=CDBDriver}catch(e){}