'use strict';var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,'value'in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a};function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var btoa=function(a){var b;return b=a instanceof Buffer?a:new Buffer(a.toString(),'binary'),b.toString('base64')},_isset=function(a,b){var c,d;if(!b)d=!1;else{d=!0,b=b.toLowerCase();try{c=a instanceof b}catch(a){c=!1}}return null!=a&&a!=void 0&&(!d||('undefined'==typeof a?'undefined':_typeof(a))===b||c)&&(!d||'string'!=b||''!=a&&' '!=a)};window.CDBDriver=function(){function a(b){if(_classCallCheck(this,a),_isset(b,'object')){if(_isset(b.host,'string'))this.host=b.host;else throw new TypeError('CDBDriver configuration is missing required key: host!');_isset(b.user,'string')&&_isset(b.pass,'string')?(this._auth=!0,this.user=b.user,this.pass=b.pass):this._auth=!1}else if(_isset(b,'string'))try{if(b.includes('@')){this._auth=!0;var c=b.split('@'),d=c[0].split('//')[0]+'//',e=c[0].split('//')[1];this.user=e.split(':')[0],this.pass=e.split(':')[1],this.host=d+c[1].split(':')[0]+':'+parseInt(c[1].split(':')[1])}else this._auth=!1,this.host=b}catch(a){throw new TypeError('An error occurred while parsing CouchDB URL string.')}else throw new TypeError('Invalid configuration passed to CDBDriver constructor!');this.host.endsWith('/')||(this.host+='/');var f=this.info().response;this.legacy=!!(2>parseInt(f.version))}return _createClass(a,[{key:'_getAuthHeader',value:function _getAuthHeader(){return'Basic '+btoa(this.user+':'+this.pass)}},{key:'_setAuthHeader',value:function _setAuthHeader(a){a.withCredentials=!0,a.setRequestHeader('Authorization',this._getAuthHeader())}},{key:'_buildCURL',value:function _buildCURL(a){var b='curl ';return b+=_isset(a.method,'string')?'-X '+a.method+' ':'-X GET ',a.verbose&&(b+='-v '),_isset(a.data,'object')?(b+='-H "Content-Type: application/json" ',b+='-d "'+JSON.stringify(a.data)+'" '):_isset(a.data,'string')&&(b+='-d "'+a.data+'"'),this._auth&&(b+='-H "Authorization: '+this._getAuthHeader()+'" '),b+=_isset(a.location,'string')?this.host+a.location:this.host,b}},{key:'_parseCURLResponse',value:function _parseCURLResponse(a,b){var c,d;if(!b)try{c=JSON.parse(a)}catch(b){return a}finally{return c}else{c={},d='',a.split('\n').forEach(function(a){if(a.startsWith('*'));else if(a.startsWith('>'));else if(a.startsWith('<')){a.replace('< ','');a.includes('HTTP/')&&(c.code=parseInt(a.replace(/HTTP\/[^s]+ /,'')))}else d+=a});try{c.body=JSON.parse(d)}catch(a){c.body=d}finally{return c}}}},{key:'info',value:function info(a){var b=this,c=new XMLHttpRequest;if(_isset(a,'function'))c.addEventListener('load',function(){try{var b=JSON.parse(c.response)}catch(a){var b=c.response}a({state:c.status,response:b})}),c.open('GET',this.host),this._auth&&this._setAuthHeader(c),c.send();else{c.open('GET',this.host,!1),this._auth&&this._setAuthHeader(c),c.send();try{var d=JSON.parse(c.response)}catch(a){var d=c.response}return{state:c.status,response:d}}}},{key:'allDbs',value:function allDbs(a){var b=new XMLHttpRequest;if(_isset(a,'function'))b.addEventListener('load',function(){try{var c=JSON.parse(b.response)}catch(a){var c=b.response}a({state:b.status,response:c})}),b.open('GET',this.host+'_all_dbs'),this._auth&&this._setAuthHeader(b),b.send();else{b.open('GET',this.host+'_all_dbs',!1),this._auth&&this._setAuthHeader(b),b.send();try{var c=JSON.parse(b.response)}catch(a){var c=b.response}return{state:b.status,response:c}}}},{key:'getDb',value:function getDb(a,b){if(!_isset(a,'string'))throw new Error('CDBDriver.db() is missing required argument: dbIdentifier!');var c=new XMLHttpRequest;if(_isset(b,'function'))c.addEventListener('load',function(){try{var a=JSON.parse(c.response)}catch(a){var a=c.response}b({state:c.status,response:a})}),c.open('GET',this.host+a),this._auth&&this._setAuthHeader(c),c.send();else{c.open('GET',this.host+a,!1),this._auth&&this._setAuthHeader(c),c.send();try{var d=JSON.parse(c.response)}catch(a){var d=c.response}return{state:c.status,response:d}}}},{key:'createDb',value:function createDb(a,b){if(!_isset(a,'string'))throw new Error('CDBDriver.createDb() is missing required argument: dbIdentifier!');var c=new XMLHttpRequest;if(_isset(b,'function'))c.addEventListener('load',function(){try{var a=JSON.parse(c.response)}catch(a){var a=c.response}b({state:c.status,response:a})}),c.open('PUT',this.host),this._auth&&this._setAuthHeader(c),c.send();else{c.open('PUT',this.host+a,!1),this._auth&&this._setAuthHeader(c),c.send();try{var d=JSON.parse(c.response)}catch(a){var d=c.response}return{state:c.status,response:d}}}},{key:'getDocs',value:function getDocs(a,b){if(!_isset(a,'string'))throw new Error('CDBDriver.getDocs() is missing required argument: dbIdentifier!');var c=new XMLHttpRequest;if(_isset(b,'function'))c.addEventListener('load',function(){try{var a=JSON.parse(c.response)}catch(a){var a=c.response}b({state:c.status,response:a})}),c.open('GET',this.host+a+'/_all_docs'),this._auth&&this._setAuthHeader(c),c.send();else{c.open('GET',this.host+a+'/_all_docs',!1),this._auth&&this._setAuthHeader(c),c.send();try{var d=JSON.parse(c.response)}catch(a){var d=c.response}return{state:c.status,response:d}}}},{key:'storeDoc',value:function storeDoc(a,b,c){if(!_isset(a,'string'))throw new Error('CDBDriver.storeDoc() is missing required argument: dbIdentifier!');else if(!_isset(b,'object'))throw new Error('CDBDriver.storeDoc() is missing required argument: data!');var d=new XMLHttpRequest;if(_isset(c,'function'))d.addEventListener('load',function(){try{var a=JSON.parse(d.response)}catch(a){var a=d.response}c({state:d.status,response:a})}),d.open('POST',this.host+a),this._auth&&this._setAuthHeader(d),d.setRequestHeader('Content-Type','application/json'),d.send(JSON.stringify(b));else{d.open('POST',this.host+a,!1),this._auth&&this._setAuthHeader(d),d.setRequestHeader('Content-Type','application/json'),d.send(JSON.stringify(b));try{var e=JSON.parse(d.response)}catch(a){var e=d.response}return{state:d.status,response:e}}}},{key:'getDoc',value:function getDoc(a,b,c){if(!_isset(a,'string'))throw new Error('CDBDriver.getDoc() is missing required argument: dbIdentifier!');else if(!_isset(b,'string'))throw new Error('CDBDriver.getDoc() is missing required argument: docIdentifier!');var d=new XMLHttpRequest;if(_isset(c,'function'))d.addEventListener('load',function(){try{var a=JSON.parse(d.response)}catch(a){var a=d.response}c({state:d.status,response:a})}),d.open('GET',this.host+a+'/'+b),this._auth&&this._setAuthHeader(d),d.send();else{d.open('GET',this.host+a+'/'+b,!1),this._auth&&this._setAuthHeader(d),d.send();try{var e=JSON.parse(d.response)}catch(a){var e=d.response}return{state:d.status,response:e}}}},{key:'deleteDoc',value:function deleteDoc(a,b,c,d){if(!_isset(a,'string'))throw new Error('CDBDriver.deleteDoc() is missing required argument: dbIdentifier!');else if(!_isset(b,'string'))throw new Error('CDBDriver.deleteDoc() is missing required argument: docIdentifier!');else if(!_isset(c,'string'))throw new Error('CDBDriver.deleteDoc() is missing required argument: docRevision!');var e=new XMLHttpRequest;if(_isset(d,'function'))e.addEventListener('load',function(){try{var a=JSON.parse(e.response)}catch(a){var a=e.response}d({state:e.status,response:a})}),e.open('DELETE',this.host+a+'/'+b+'?rev='+c),this._auth&&this._setAuthHeader(e),e.send();else{e.open('DELETE',this.host+a+'/'+b+'?rev='+c,!1),this._auth&&this._setAuthHeader(e),e.send();try{var f=JSON.parse(e.response)}catch(a){var f=e.response}return{state:e.status,response:f}}}},{key:'updateDoc',value:function updateDoc(a,b,c,d,e){if(!_isset(a,'string'))throw new Error('CDBDriver.updateDoc() is missing required argument: dbIdentifier!');else if(!_isset(b,'string'))throw new Error('CDBDriver.updateDoc() is missing required argument: docIdentifier!');else if(!_isset(c,'string'))throw new Error('CDBDriver.updateDoc() is missing required argument: docRevision!');else if(!_isset(d,'object'))throw new Error('CDBDriver.updateDoc() is missing required argument: data!');var f=new XMLHttpRequest;if(_isset(e,'function'))f.addEventListener('load',function(){try{var a=JSON.parse(f.response)}catch(a){var a=f.response}e({state:f.status,response:a})}),f.open('PUT',this.host+a+'/'+b+'?rev='+c),this._auth&&this._setAuthHeader(f),f.setRequestHeader('Content-Type','application/json'),f.send(JSON.stringify(d));else{f.open('PUT',this.host+a+'/'+b+'?rev='+c,!1),this._auth&&this._setAuthHeader(f),f.setRequestHeader('Content-Type','application/json'),f.send(JSON.stringify(d));try{var g=JSON.parse(f.response)}catch(a){var g=f.response}return{state:f.status,response:g}}}},{key:'storeUser',value:function storeUser(a,b){if(!_isset(a.username,'string'))throw new Error('CDBDriver.storeUser() is missing required argument: username!');else if(!_isset(a.password,'string'))throw new Error('CDBDriver.storeUser() is missing required argument: password!');var c={_id:'org.couchdb.user:'+a.username,name:a.username,roles:_isset(a.roles,'object')?a.roles:[],type:'user',password:a.password};if(_isset(a.additionals,'object'))for(var d in a.additionals)a.additionals.hasOwnProperty(d)&&!c.hasOwnProperty(d)&&(c[d]=a.additionals[d]);var e=new XMLHttpRequest;if(_isset(b,'function'))e.addEventListener('load',function(){try{var a=JSON.parse(e.response)}catch(a){var a=e.response}b({state:e.status,response:a})}),e.open('PUT',this.host+'_users/'+c._id),this._auth&&this._setAuthHeader(e),e.setRequestHeader('Content-Type','application/json'),e.send(JSON.stringify(c));else{e.open('PUT',this.host+'_users/'+c._id,!1),this._auth&&this._setAuthHeader(e),e.setRequestHeader('Content-Type','application/json'),e.send(JSON.stringify(c));try{var f=JSON.parse(e.response)}catch(a){var f=e.response}return{state:e.status,response:f}}}},{key:'storeAdmin',value:function storeAdmin(a,b,c){if(!_isset(a,'string'))throw new Error('CDBDriver.storeUser() is missing required argument: username!');else if(!_isset(b,'string'))throw new Error('CDBDriver.storeUser() is missing required argument: password!');if(this.legacy)var d=this.host+'_config/admins/'+a;else var d=this.host+'_node/_local/_config/admins/'+a;var e=new XMLHttpRequest;if(_isset(c,'function'))e.addEventListener('load',function(){try{var a=JSON.parse(e.response)}catch(a){var a=e.response}c({state:e.status,response:a})}),e.open('PUT',d),this._auth&&this._setAuthHeader(e),e.setRequestHeader('Content-Type','application/json'),e.send('"'+b+'"');else{e.open('PUT',d,!1),this._auth&&this._setAuthHeader(e),e.setRequestHeader('Content-Type','application/json'),e.send('"'+b+'"');try{var f=JSON.parse(e.response)}catch(a){var f=e.response}return{state:e.status,response:f}}}}]),a}();